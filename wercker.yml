box: golang
build:
  steps:
    - setup-go-workspace

    - script:
        name: go get
        code: |
          go get

    - script:
        name: go build
        code: |
          go build ./...

    - script:
        name: go test
        code: |
          go test ./...
deploy:
  steps:
    - script:
        name: show environments
        code: |
          env
          git config --list --local
    - script:
        name: install tools
        code: |
          go get github.com/motemen/gobump/cmd/gobump
          curl -s http://stedolan.github.io/jq/download/linux64/jq -o ./jq
          chmod +x ./jq
    - script:
        name: setup user
        code: |
          git config --global user.email 'pleasemailus@wercker.com'
          git config --global user.name  'werckerbot'
    - script:
        name: bump version
        code: |
          pr_number=$(git show --pretty=%s | sed -n 's/^Merge pull request #\([0-9]\{1,\}\) .*/\1/p')
          if [ -n "$pr_number" ]; then
            labels=$(curl -s -H "Authorization: token $GITHUB_TOKEN" https://api.github.com/repos/motemen/gore/issues/$pr_numbeer/labels | ./jq -r 'map(.name) | join("\n")')

            flag='-patch'
            if [ -n "$(echo $labels | grep -i -E '^breaking$')" ]; then
              flag='-major'
            elif [ -n "$(echo $labels | grep -i -E '^feature$')" ]; then
              flag='-minor'
            fi

            new_version=$(gobump $flag -w -v | ./jq -r '.[]')

            git diff --exit-code || ( git commit -a -m "bump version to $new_version" && git push https://$GITHUB_TOKEN@github.com/motemen/test-repository HEAD:master )
          fi
